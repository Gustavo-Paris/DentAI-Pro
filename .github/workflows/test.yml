name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm turbo run lint

      - name: Security audit
        run: pnpm audit --audit-level=critical --prod

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm turbo run type-check

  test:
    name: Tests (${{ matrix.shard }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1/8, 2/8, 3/8, 4/8, 5/8, 6/8, 7/8, 8/8]
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      VITE_SUPABASE_URL: https://placeholder.supabase.co
      VITE_SUPABASE_PUBLISHABLE_KEY: placeholder-key-for-ci
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        run: cd apps/web && npx vitest run --no-file-parallelism --shard=${{ matrix.shard }} --exclude='**/useEvaluationDetail.test.ts' --reporter=basic

  test-heavy:
    name: Tests (heavy)
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      VITE_SUPABASE_URL: https://placeholder.supabase.co
      VITE_SUPABASE_PUBLISHABLE_KEY: placeholder-key-for-ci
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run heavy test in isolation
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        run: cd apps/web && npx vitest run src/hooks/__tests__/useEvaluationDetail.test.ts --reporter=basic

  deno-test:
    name: Deno Tests (Edge Functions)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: denoland/setup-deno@v2

      - name: Run Deno tests
        working-directory: supabase/functions
        run: deno test --allow-read --allow-env --allow-net .

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [test, test-heavy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      VITE_SUPABASE_URL: https://placeholder.supabase.co
      VITE_SUPABASE_PUBLISHABLE_KEY: placeholder-key-for-ci
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
        run: cd apps/web && npx vitest run --coverage --reporter=basic

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: apps/web/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, test-heavy, deno-test]
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
      VITE_SUPABASE_URL: https://placeholder.supabase.co
      VITE_SUPABASE_PUBLISHABLE_KEY: placeholder-key-for-build
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm turbo run build

      - name: Check bundle size
        run: |
          DIST_DIR="apps/web/dist"
          if [ -d "$DIST_DIR/assets" ]; then
            TOTAL_JS=$(find "$DIST_DIR/assets" -name '*.js' -exec wc -c {} + | tail -1 | awk '{print $1}')
            TOTAL_CSS=$(find "$DIST_DIR/assets" -name '*.css' -exec wc -c {} + | tail -1 | awk '{print $1}')
            JS_KB=$((TOTAL_JS / 1024))
            CSS_KB=$((TOTAL_CSS / 1024))
            echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
            echo "| Asset | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| JS (total) | ${JS_KB} KB |" >> $GITHUB_STEP_SUMMARY
            echo "| CSS (total) | ${CSS_KB} KB |" >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "JS: ${JS_KB} KB, CSS: ${CSS_KB} KB"
            # Fail if JS bundle exceeds 8MB (8192 KB)
            if [ "$JS_KB" -gt 8192 ]; then
              echo "::error::JS bundle size (${JS_KB} KB) exceeds 8MB limit"
              exit 1
            fi
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: apps/web/dist/
          retention-days: 7

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: true
    timeout-minutes: 20
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Configure GitHub Packages registry
        run: |
          echo "@parisgroup-ai:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=\${GITHUB_TOKEN}" >> .npmrc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - uses: supabase/setup-cli@v1

      - name: Start local Supabase
        run: |
          supabase start -x imgproxy,inbucket,logflare,vector,edge-runtime
          echo "SUPABASE_URL=$(supabase status -o env | grep API_URL | cut -d= -f2)" >> "$GITHUB_ENV"
          echo "SUPABASE_ANON_KEY=$(supabase status -o env | grep ANON_KEY | cut -d= -f2)" >> "$GITHUB_ENV"

      - name: Run E2E tests
        env:
          VITE_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ env.SUPABASE_ANON_KEY }}
          E2E_USER_EMAIL: e2e@test.local
          E2E_USER_PASSWORD: Test123456!
        run: cd apps/web && npx playwright test --project=chromium

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 14

      - name: Stop Supabase
        if: always()
        run: supabase stop --no-backup
