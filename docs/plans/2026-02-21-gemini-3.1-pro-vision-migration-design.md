---
title: "Gemini 3.1 Pro Vision Migration Design"
created: 2026-02-21
updated: 2026-02-21
status: approved
tags:
  - type/design
  - domain/ai
  - domain/infrastructure
---

# Gemini 3.1 Pro Vision Migration Design

## Context

Google released Gemini 3.1 Pro on 2026-02-19 with strong reasoning benchmarks (ARC-AGI-2 77.1%, SWE-Bench 80.6%, GPQA Diamond 94.3%) at the same price as Gemini 3 Pro ($2/M input, $12/M output). This design evaluates replacing Claude Sonnet 4.6 in vision tasks with Gemini 3.1 Pro.

## Decision

**Approach A: Replace Sonnet 4.6 in vision tasks only.** Keep Haiku 4.5 for text tasks (2.5x cheaper than Gemini 3.1 Pro).

### Functions That Change (2 of 6)

| Function | From | To |
|----------|------|----|
| `analyze-dental-photo` | Claude Sonnet 4.6 (vision+tools) | Gemini 3.1 Pro (vision+tools) |
| `generate-dsd/proportions-analysis` | Claude Sonnet 4.6 (vision+tools) | Gemini 3.1 Pro (vision+tools) |

### Functions That Do NOT Change (4 of 6)

| Function | Model | Reason |
|----------|-------|--------|
| `recommend-resin` | Claude Haiku 4.5 | Haiku is 2.5x cheaper for text tasks |
| `recommend-cementation` | Claude Haiku 4.5 | Haiku is 2.5x cheaper for text tasks |
| `smile-line-classifier` | Claude Haiku 4.5 | Simple task, Haiku sufficient |
| `generate-dsd/simulation` | Gemini 3 Pro Image | Only option for image generation |

## Technical Changes

### A. Edge Functions — Swap imports

- `analyze-dental-photo/index.ts`: `callClaudeVisionWithTools` → `callGeminiVisionWithTools`
- `generate-dsd/proportions-analysis.ts`: `callClaudeVisionWithTools` + `callClaudeVision` → `callGeminiVisionWithTools` + `callGeminiVision`
- Model param: `"claude-sonnet-4-6"` → `"gemini-3.1-pro-preview"` (confirm exact model ID)

### B. Prompt Registry — Update metadata

- `dsd-analysis.ts`: model → `gemini-3.1-pro-preview`, provider → `Gemini`
- `analyze-dental-photo.ts`: model → `gemini-3.1-pro-preview`, provider → `Gemini`

### C. Metrics — Add cost rate

```typescript
'gemini-3.1-pro-preview': { input: 0.002, output: 0.012 }
```

### D. Cross-Provider Fallback

New fallback chain:
```
Gemini 3.1 Pro (primary)
  ↓ 5xx error after N attempts
Claude Sonnet 4.6 (fallback)
```

Requires fallback logic at edge function level — after Gemini fails, call `callClaudeVisionWithTools` with same messages/tools (OpenAI-style interface is shared).

### E. Enum Normalization

Reinforce PT/EN enum normalization in post-processing for both functions (known Gemini issue — sometimes returns English enum values instead of Portuguese).

### F. ThinkingLevel

Set `thinkingLevel: "low"` on all Gemini 3.1 Pro calls to avoid excessive latency (Gemini 3+ defaults to "high").

## Cost Impact

Per typical call (~2K input + 3K output tokens):
- Before (Sonnet 4.6): $0.006 + $0.045 = **$0.051**
- After (Gemini 3.1 Pro): $0.004 + $0.036 = **$0.040**
- **Savings: ~22% per vision call**

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Clinical regression in dental analysis | Side-by-side testing with real cases before prod deploy |
| English enum values | Robust normalization in post-processing (pattern exists) |
| Excessive latency with thinking | Explicit `thinkingLevel: "low"` |
| Gemini 3.1 Pro instability (preview) | Cross-provider fallback to Claude Sonnet 4.6 |
| Tool calling schema incompatibility | `cleanSchemaForGemini()` already strips incompatible fields |
| Edge function timeout (60s) | Gemini tends to be faster than Sonnet for vision tasks |

## Provider Distribution (After Migration)

- **Gemini 3.1 Pro**: Vision analysis (photo + DSD proportions)
- **Gemini 3 Pro Image**: DSD simulation (image generation)
- **Claude Haiku 4.5**: Text tasks (resin, cementation, smile-line)
- **Claude Sonnet 4.6**: Fallback for vision tasks

## Sources

- [Gemini 3.1 Pro Launch Blog](https://blog.google/innovation-and-ai/models-and-research/gemini-models/gemini-3-1-pro/)
- [Gemini 3.1 Pro Pricing & Benchmarks](https://llm-stats.com/blog/research/gemini-3.1-pro-launch)
- [Gemini 3.1 Pro vs Claude Opus 4.6 Comparison](https://help.apiyi.com/en/gemini-3-1-pro-preview-vs-claude-opus-4-6-comparison-en.html)
- [Gemini 3.1 Pro Image Generation Clarification](https://help.apiyi.com/en/gemini-3-1-pro-preview-image-generation-not-supported-en.html)
- [Artificial Analysis Performance](https://artificialanalysis.ai/models/gemini-3-1-pro-preview)
